<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat - Вход</title>
    <link rel="stylesheet" href="../css/login.css">
    <script src="../js/services/auth.js"></script>
    <script src="../js/utils/validator.js"></script>
    <script>
        function showTab(tabName) {
            document.getElementById('loginForm').style.display = (tabName === 'login') ? 'block' : 'none';
            document.getElementById('registerForm').style.display = (tabName === 'register') ? 'block' : 'none';
        }

        const getData = (formId) => {
            const form = document.getElementById(formId)
            const inputs = form.getElementsByTagName("input")
            const data = {}
            for (let input of inputs) {
                data[input.name] = input.value
            }
            return data
        }

        const handlerSubmitLogin = async () => {
        const data = getData("loginForm");
        const stateValidate = validateForm(data);
        if (Object.keys(stateValidate).length == 0) {
            const response = await loginUser(data);
            if (typeof response != "string") {
                // Сохраняем данные пользователя в localStorage
                localStorage.setItem('user', JSON.stringify(response));
                window.location.href = "profile.html";  // Перенаправляем на страницу профиля
            } else {
                alert(response);
            }
        } else {
            for (let key in stateValidate) {
                switch (key) {
                    case "userName":
                        document.getElementById("error__userName").innerHTML = stateValidate[key];
                        break;
                    case "password":
                        document.getElementById("error__password").innerHTML = stateValidate[key];
                        break;
                    default:
                        throw new Error("Ошибка валидации");
                        break;
                }
            }
        }
    };

    const handlerSubmitRegister = async () => {
    const data = getData("registerForm");
    const stateValidate = validateForm(data);
    if (Object.keys(stateValidate).length == 0) {
        const response = await registerUser(data);
        if (typeof response != "string") {
            // Сохраняем данные пользователя в localStorage
            localStorage.setItem('user', JSON.stringify(response));
            window.location.href = "profile.html";  // Перенаправляем на страницу профиля
        } else {
            alert(response);
        }
    } else {
        for (let key in stateValidate) {
            switch (key) {
                case "name":
                    document.getElementById("error__name").innerHTML = stateValidate[key];
                    break;
                case "userName":
                    document.getElementById("error__userName").innerHTML = stateValidate[key];
                    break;
                case "email":
                    document.getElementById("error__email").innerHTML = stateValidate[key];
                    break;
                case "password":
                    document.getElementById("error__password").innerHTML = stateValidate[key];
                    break;
                default:
                    throw new Error("Ошибка валидации");
                    break;
            }
        }
    }
};

    </script>
</head>

<body>
    <header>
        <div class="logo">Heat</div>
        <nav>
            <ul>
                <li><a href="store.html">Магазин</a></li>
                <li><a href="about.html">О нас</a></li>
                <li><a id="auth-link" href="login.html" class="active">Вход</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="auth">
            <h1>Вход</h1>
            <div class="tabs">
                <button onclick="showTab('login')">Авторизация</button>
                <button onclick="showTab('register')">Регистрация</button>
            </div>

            <div id="loginForm" style="display: block;">
                <form onsubmit=" event.preventDefault();handlerSubmitLogin()">
                    <input type="text" name="userName" placeholder="Логин" required>
                    <div class="error" id="error__userName"></div>
                    <input type="password" name="password" placeholder="Пароль" required>
                    <div class="error" id="error__password"></div>
                    <button type="submit">Войти</button>
                </form>
            </div>

            <div id="registerForm" style="display: none;">
                <h2>Регистрация пользователя</h2>
                <form onsubmit="event.preventDefault();handlerSubmitRegister()">
                    <input type="text" name="name" placeholder="Имя" required>
                    <div class="error" id="error__name"></div>
                    <input type="text" name="userName" placeholder="Логин" required>
                    <div class="error" id="error__userName"></div>
                    <input type="email" name="email" placeholder="Email" required>
                    <div class="error" id="error__email"></div>
                    <input type="password" name="password" placeholder="Пароль" required>
                    <div class="error" id="error__password"></div>
                    <input type="date" name="dob" placeholder="Дата рождения" required>
                    <button type="submit">Зарегистрироваться</button>
                </form>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Heat. Все права защищены.</p>
    </footer>
    <script>
        const authLink = document.getElementById('auth-link');
        const user = localStorage.getItem('user');

        if (user) {
            // Если пользователь авторизован, меняем ссылку на "Профиль"
            authLink.textContent = "Профиль";
            authLink.href = "profile.html";
        } else {
            // Если пользователь не авторизован, ссылка остается на "Вход"
            authLink.textContent = "Вход";
            authLink.href = "login.html";
        }
    </script>


</body>

</html>