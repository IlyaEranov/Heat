<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="game-title">Название игры</title>
    <link rel="stylesheet" href="../css/gamepage.css">
    <script src="../js/services/users.js"></script>
    <script src="../js/services/games.js"></script>
</head>

<body>
    <header>
        <div class="logo">Heat</div>
        <nav>
            <ul>
                <li><a href="store.html" class="active">Магазин</a></li>
                <li><a href="about.html">О нас</a></li>
                <li><a id="auth-link" href="login.html">Вход</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1 class="game-title" id="game-title-display">Название игры</h1>

        <div class="game-container">
            <div class="media-carousel">
                <div class="selected-media">
                    <video id="selected-video" controls="">
                        <source src="" type="video/mp4">
                    </video>
                </div>
                <div class="carousel"></div>
            </div>

            <div class="game-details">
                <p class="game-description" id="game-description"></p>
                <p class="game-info" id="game-info"></p>
                <button id="button-cart" class="add-to-cart">Добавить в корзину</button>
            </div>
        </div>

        <div id="review" class="review-section" style="display: none;">
            <h2>Оцените игру</h2>
            <div class="review-stars">
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="2">&#9733;</span>
                <span class="star" data-value="3">&#9733;</span>
                <span class="star" data-value="4">&#9733;</span>
                <span class="star" data-value="5">&#9733;</span>
            </div>
            <button class="submit-review" disabled>Оставить отзыв</button>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Heat. Все права защищены.</p>
    </footer>

    <script>
        userIsAuthLink();

        // Функция для получения параметра из URL
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const gameId = getParameterByName('id');

        async function selectMedia(src) {
            const games = await getGames();
            const game = games.find(g => g.id == gameId);
            const selectedMedia = document.querySelector('.selected-media');
            console.log(src);
            if (src.endsWith('.mp4') || src.endsWith('.webm')) {
                selectedMedia.innerHTML = `<video controls muted autoplay>
                    <source src="../static/games/${game.title}/${src}" type="video/mp4">
                </video>`;
            } else {
                selectedMedia.innerHTML = `<img src="../static/games/${game.title}/${src}" alt="Selected media">`;
            }
        }

        async function loadGameData() {
            const games = await getGames();
            const game = games.find(g => g.id == gameId);
            const user = JSON.parse(localStorage.getItem("user"));
            const isAuth = user !== null;
            const buttonCart = document.getElementById("button-cart");

            if (isAuth) {
            if (Array.isArray(user.gamesId) && user.gamesId.find(e => e == game.id)) {
                document.getElementById("review").style.display = "block";
                buttonCart.innerText = "В библиотеке";
                buttonCart.disabled = true; 
            } 
            else if (Array.isArray(user.cartId) && user.cartId.find(e => e == game.id)) {
                buttonCart.innerText = "В корзине";
                buttonCart.disabled = true;
            } 
            else {
                buttonCart.addEventListener("click", async (e) => {
                    e.preventDefault();
                    await addGameInCart(game.id); 
                    buttonCart.innerText = "В корзине";
                    buttonCart.disabled = true;  
                })}
            } else {
                buttonCart.addEventListener("click", (e) => {
                    e.preventDefault();
                    window.location.href = "login.html";  
                });
            }

            try {
                if (game) {
                    document.getElementById('game-title').innerText = game.title;
                    document.getElementById('game-title-display').innerText = game.title;
                    document.getElementById('game-description').innerText = game.description;
                    document.getElementById('game-info').innerHTML = `
                        <strong>Разработчик:</strong> ${game.developer} <br>
                        <strong>Дата релиза:</strong> ${new Date(game.releaseDate).toLocaleDateString()} <br>
                        <strong>Цена:</strong> ${game.price} руб.<br>
                    `;

                    const mediaCarousel = document.querySelector('.carousel');
                    const selectedMedia = document.querySelector('.selected-media');

                    selectedMedia.innerHTML = `<video id="selected-video" muted autoplay controls>
                        <source src="../static/games/${game.title}/${game.trailer}" type="video/mp4">
                    </video>`;

                    mediaCarousel.innerHTML = `<img src="../assets/images/videoPreview.png" alt="${game.trailer}" class="carousel-item" onclick="selectMedia('${game.trailer}')">`;

                    game.images.forEach(image => {
                        mediaCarousel.innerHTML += `<img src="../static/games/${game.title}/${image}" alt="${image}" class="carousel-item" onclick="selectMedia('${image}')">`;
                    });
                } else {
                    alert('Игра не найдена.');
                }
            } catch (error) {
                console.error('Ошибка загрузки данных о игре:', error);
                alert('Не удалось загрузить данные о игре.');
            }
        }

        loadGameData();
    </script>
</body>

</html>
